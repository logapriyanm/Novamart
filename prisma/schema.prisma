// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  MANUFACTURER
  DEALER
  CUSTOMER
}

enum AccountStatus {
  ACTIVE
  PENDING
  UNDER_VERIFICATION
  SUSPENDED
}

enum OrderStatus {
  CREATED
  PAID
  CONFIRMED
  SHIPPED
  DELIVERED
  SETTLED
  CANCELLED
  DISPUTED
}

enum EscrowStatus {
  HOLD
  FROZEN
  RELEASED
  REFUNDED
}

enum DisputeStatus {
  OPEN
  EVIDENCE_COLLECTION
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

enum AdminRole {
  SUPER_ADMIN
  OPS_ADMIN
  FINANCE_ADMIN
  SUPPORT_ADMIN
}

model User {
  id            String        @id @default(uuid())
  email         String?       @unique
  phone         String?       @unique
  password      String?
  role          Role
  adminRole     AdminRole?    // Only for role=ADMIN
  status        AccountStatus @default(PENDING)
  mfaEnabled    Boolean       @default(false)
  
  // Specific Role Relations
  manufacturer  Manufacturer?
  dealer        Dealer?
  customer      Customer?

  // Audit and Auth
  sessions      Session[]
  auditLogs     AuditLog[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([role])
  @@index([status])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  ipAddress String?
  device    String?
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Manufacturer {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  companyName     String
  registrationNo  String   @unique
  factoryAddress  String
  gstNumber       String   @unique
  bankDetails     Json     // Encrypted or structured JSON
  certifications  String[]
  products        Product[]
  dealersApproved Dealer[] @relation("ApprovedDealers")
}

model Dealer {
  id                String         @id @default(uuid())
  userId            String         @unique
  user              User           @relation(fields: [userId], references: [id])
  businessName      String
  gstNumber         String         @unique
  businessAddress   String
  bankDetails       Json
  inventory         Inventory[]
  orders            Order[]        @relation("DealerOrders")
  customerRatings   Rating[]
  approvedBy        Manufacturer[] @relation("ApprovedDealers")
}

model Customer {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  name      String
  orders    Order[]
  ratings   Rating[]
}

model Product {
  id              String       @id @default(uuid())
  manufacturerId  String
  manufacturer    Manufacturer @relation(fields: [manufacturerId], references: [id])
  name            String
  description     String
  basePrice       Decimal      @db.Decimal(12, 2)
  moq             Int          @default(1) // Minimum Order Quantity
  category        String
  colors          String[]     // Hex codes for swatches
  sizes           String[]     // e.g., ["XS", "S", "M"]
  rating          Float        @default(4.5)
  isApproved      Boolean      @default(false)
  rejectionReason String?      // For Admin feedback
  inventory       Inventory[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model Inventory {
  id        String  @id @default(uuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])
  dealerId  String
  dealer    Dealer  @relation(fields: [dealerId], references: [id])
  region    String
  stock     Int     @default(0)
  locked    Int     @default(0) // Quantity currently in pending orders
  price     Decimal @db.Decimal(12, 2) // Retail price set by dealer
  originalPrice Decimal? @db.Decimal(12, 2) // For strike-through pricing
  discount  Int?    // Percentage
  orderCount Int     @default(0) // Total orders for this dealer's listing
}

model Order {
  id                String       @id @default(uuid())
  customerId        String
  customer          Customer     @relation(fields: [customerId], references: [id])
  dealerId          String
  dealer            Dealer       @relation(fields: [dealerId], references: [id], name: "DealerOrders")
  status            OrderStatus  @default(CREATED)
  totalAmount       Decimal      @db.Decimal(12, 2)
  taxAmount         Decimal      @db.Decimal(12, 2)
  commissionAmount  Decimal      @db.Decimal(12, 2)
  items             OrderItem[]
  escrow            Escrow?
  dispute           Dispute?
  timeline          OrderLog[]
  invoiceUrl        String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  quantity  Int
  price     Decimal @db.Decimal(12, 2)
}

model OrderLog {
  id        String      @id @default(uuid())
  orderId   String
  order     Order       @relation(fields: [orderId], references: [id])
  fromState OrderStatus
  toState   OrderStatus
  reason    String?
  timestamp DateTime    @default(now())
}

model Escrow {
  id           String       @id @default(uuid())
  orderId      String       @unique
  order        Order        @relation(fields: [orderId], references: [id])
  status       EscrowStatus @default(HOLD)
  amount       Decimal      @db.Decimal(12, 2)
  lockedAt     DateTime     @default(now())
  releasedAt   DateTime?
  refundedAt   DateTime?
}

model Dispute {
  id              String        @id @default(uuid())
  orderId         String        @unique
  order           Order         @relation(fields: [orderId], references: [id])
  raisedByUserId  String
  reason          String
  status          DisputeStatus @default(OPEN)
  evidence        Evidence[]
  adminDecision   String?
  resolvedAt      DateTime?
  createdAt       DateTime      @default(now())
}

model Evidence {
  id        String   @id @default(uuid())
  disputeId String
  dispute   Dispute  @relation(fields: [disputeId], references: [id])
  fileUrl   String
  type      String   // e.g., "UNBOXING_VIDEO", "POD", "INVOICE"
  uploadedBy String  // userId
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  entity    String   // e.g., "ORDER", "USER", "ESCROW"
  entityId  String
  oldData   Json?
  newData   Json?
  reason    String?
  ipAddress String?
  device    String?
  method    String?  // e.g., "POST", "PUT"
  timestamp DateTime @default(now())

  @@index([entity, entityId])
}

model MarginRule {
  id          String   @id @default(uuid())
  category    String
  maxCap      Decimal  @db.Decimal(5, 2)
  minMOQ      Int      @default(1)
  isActive    Boolean  @default(true)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TaxRule {
  id          String   @id @default(uuid())
  region      String
  taxSlab     Decimal  @db.Decimal(5, 2)
  category    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Badge {
  id          String   @id @default(uuid())
  name        String   @unique
  icon        String?
  description String
  autoRule    Json?    // Conditions for automatic badge assignment
  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id])
  assignedAt DateTime @default(now())
  assignedBy String?  // adminId
}

model Rating {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  dealerId   String?
  dealer     Dealer?  @relation(fields: [dealerId], references: [id])
  rating     Int      @default(5)
  comment    String?
  createdAt  DateTime @default(now())
}
model PlatformSettings {
  id             String   @id @default(uuid())
  key            String   @unique
  value          Json
  description    String?
  updatedAt      DateTime @updatedAt
}
