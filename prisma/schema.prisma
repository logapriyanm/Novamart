generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

model OrderTimeline {
  id        String      @id @default(uuid())
  orderId   String
  fromState OrderStatus
  toState   OrderStatus
  reason    String?
  metadata  Json?
  createdAt DateTime    @default(now())
  order     Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_timelines")
}

model User {
  id            String         @id @default(uuid())
  email         String?        @unique
  phone         String?        @unique
  password      String?
  role          Role
  adminRole     AdminRole?
  status        AccountStatus  @default(PENDING)
  mfaEnabled    Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  avatar        String?
  dob           DateTime?
  fcmToken      String?
  interests     UserInterest[]
  customer      Customer?
  dealer        Dealer?
  documents     Document[]
  manufacturer  Manufacturer?
  notifications Notification[]
  sessions      Session[]
  refreshToken  String?
  userBadges    UserBadge[]
  behaviors     UserBehavior[]

  @@index([role])
  @@index([status])
  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  ipAddress String?
  device    String?
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@map("sessions")
}

model Manufacturer {
  id                 String                    @id @default(uuid())
  userId             String                    @unique
  companyName        String
  registrationNo     String                    @unique
  businessType       String?
  officialEmail      String?
  phone              String?
  factoryAddress     String
  capacity           String?
  categoriesProduced String[]
  gstNumber          String                    @unique
  certifications     String[]
  isVerified         Boolean                   @default(false)
  logo               String?
  brandDescription   String?
  marketingMaterials String[]
  bankDetails        Json
  user               User                      @relation(fields: [userId], references: [id])
  negotiations       Negotiation[]
  products           Product[]
  dealersApproved    Dealer[]                  @relation("ApprovedDealers")
  dealerRequests     DealerRequest[]
  pooledDemands      PooledDemand[]
  dealerBlocks       ManufacturerDealerBlock[] // Phase 8: Blocked dealers

  @@map("manufacturers")
}

model Dealer {
  id                  String                    @id @default(uuid())
  userId              String                    @unique
  businessName        String
  ownerName           String?
  businessType        String?
  contactEmail        String?
  phone               String?
  gstNumber           String                    @unique
  gstCertificate      String?
  businessRegDoc      String?
  businessAddress     String
  city                String?
  state               String?
  pincode             String?
  serviceRegions      String[]
  bankDetails         Json
  payoutBlocked       Boolean                   @default(false)
  averageRating       Float                     @default(0)
  reviewCount         Int                       @default(0)
  isVerified          Boolean                   @default(false)
  subscriptions       DealerSubscription[]
  user                User                      @relation(fields: [userId], references: [id])
  inventory           Inventory[]
  negotiations        Negotiation[]
  orders              Order[]                   @relation("DealerOrders")
  customerRatings     Rating[]
  sellerReviews       SellerReview[]
  approvedBy          Manufacturer[]            @relation("ApprovedDealers")
  partnershipRequests DealerRequest[]
  PoolParticipant     PoolParticipant[]
  performanceMetrics  DealerPerformanceMetrics? // Phase 8: Performance tracking
  blockedBy           ManufacturerDealerBlock[] // Phase 8: Blocking by manufacturers

  @@map("dealers")
}

model Customer {
  id             String          @id @default(uuid())
  userId         String          @unique
  name           String
  cart           Cart?
  user           User            @relation(fields: [userId], references: [id])
  orders         Order[]
  productReviews ProductReview[]
  ratings        Rating[]
  sellerReviews  SellerReview[]

  @@map("customers")
}

model Cart {
  id         String     @id @default(uuid())
  customerId String     @unique
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  items      CartItem[]
  customer   Customer   @relation(fields: [customerId], references: [id])

  @@map("carts")
}

model CartItem {
  id          String   @id @default(uuid())
  cartId      String
  inventoryId String?
  productId   String
  quantity    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  cart        Cart     @relation(fields: [cartId], references: [id])

  @@map("cart_items")
}

model Product {
  id              String          @id @default(uuid())
  manufacturerId  String
  name            String
  description     String
  basePrice       Decimal         @db.Decimal(12, 2)
  moq             Int             @default(1)
  category        String
  colors          String[]
  sizes           String[]
  images          String[]
  video           String?
  specifications  Json?
  status          ProductStatus   @default(DRAFT)
  isApproved      Boolean         @default(false)
  rejectionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  averageRating   Float           @default(0)
  reviewCount     Int             @default(0)
  isFeatured      Boolean         @default(false)
  showOnHome      Boolean         @default(true)
  taxCategory     String?
  wholesalePrice  Decimal?        @db.Decimal(12, 2)
  inventory       Inventory[]
  negotiations    Negotiation[]
  reviews         ProductReview[]
  orderItems      OrderItem[]
  manufacturer    Manufacturer    @relation(fields: [manufacturerId], references: [id])
  pooledDemands   PooledDemand[]

  @@map("products")
}

model Inventory {
  id              String    @id @default(uuid())
  productId       String
  dealerId        String
  region          String
  stock           Int       @default(0)
  locked          Int       @default(0)
  price           Decimal   @db.Decimal(12, 2)
  originalPrice   Decimal?  @db.Decimal(12, 2)
  discount        Int?
  orderCount      Int       @default(0)
  // Phase 4: Stock Allocation Fields
  allocatedStock  Int? // Maximum stock allocated by manufacturer
  dealerMoq       Int? // Dealer-specific minimum order quantity
  dealerBasePrice Decimal?  @db.Decimal(12, 2) // Wholesale price from manufacturer
  maxMargin       Decimal?  @db.Decimal(5, 2) // Maximum margin % dealer can apply
  isAllocated     Boolean   @default(false) // Whether this is manufacturer-allocated
  // Phase 5: Dealer Listing Fields
  isListed        Boolean   @default(false) // Whether dealer has activated this listing
  marginPercent   Decimal?  @db.Decimal(5, 2) // Applied margin percentage
  listedAt        DateTime? // When dealer activated the listing
  dealer          Dealer    @relation(fields: [dealerId], references: [id])
  product         Product   @relation(fields: [productId], references: [id])

  @@map("inventories")
}

model Order {
  id               String            @id @default(uuid())
  customerId       String
  dealerId         String
  status           OrderStatus       @default(CREATED)
  totalAmount      Decimal           @db.Decimal(12, 2)
  taxAmount        Decimal           @db.Decimal(12, 2)
  commissionAmount Decimal           @db.Decimal(12, 2)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  billingAddress   String?
  shippingAddress  String
  disputes         Dispute[]
  escrow           Escrow?
  items            OrderItem[]
  timeline         OrderTimeline[]
  customer         Customer          @relation(fields: [customerId], references: [id])
  dealer           Dealer            @relation("DealerOrders", fields: [dealerId], references: [id])
  payment          Payment?
  sellerReview     SellerReview?
  shipmentTracking ShipmentTracking? // Phase 7: Shipment tracking

  @@map("orders")
}

model OrderItem {
  id            String         @id @default(uuid())
  orderId       String
  productId     String
  quantity      Int
  price         Decimal        @db.Decimal(12, 2)
  inventoryId   String?
  order         Order          @relation(fields: [orderId], references: [id])
  linkedProduct Product        @relation(fields: [productId], references: [id])
  review        ProductReview?

  @@map("order_items")
}

model Escrow {
  id               String       @id @default(uuid())
  orderId          String       @unique
  status           EscrowStatus @default(HOLD)
  amount           Decimal      @db.Decimal(12, 2)
  // Phase 7: Escrow Enhancement
  dealerAmount     Decimal?     @db.Decimal(12, 2) // Amount for dealer after commission
  platformFee      Decimal?     @db.Decimal(12, 2) // Platform commission
  releaseCondition String?      @default("DELIVERY_CONFIRMED") // Condition for release
  disputeId        String? // Link to dispute if any
  releasedAt       DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  order            Order        @relation(fields: [orderId], references: [id])

  @@map("escrows")
}

model Payment {
  id                String   @id @default(uuid())
  orderId           String   @unique
  razorpayOrderId   String?  @unique
  razorpayPaymentId String?  @unique
  amount            Decimal  @db.Decimal(12, 2)
  status            String   @default("PENDING")
  method            String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  order             Order    @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model Rating {
  id         String   @id @default(uuid())
  customerId String
  dealerId   String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id])
  dealer     Dealer   @relation(fields: [dealerId], references: [id])

  @@map("ratings")
}

model Dispute {
  id                 String        @id @default(uuid())
  orderId            String
  reason             String
  status             DisputeStatus @default(OPEN)
  createdAt          DateTime      @default(now())
  adminNotes         String?
  compensationAmount Decimal?      @db.Decimal(12, 2)
  description        String
  evidenceFiles      String[]
  raisedBy           String
  resolutionDate     DateTime?
  updatedAt          DateTime      @updatedAt
  order              Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("disputes")
}

model Badge {
  id          String      @id @default(uuid())
  name        String      @unique
  icon        String?
  description String
  users       UserBadge[]

  @@map("badges")
}

model UserBadge {
  id       String   @id @default(uuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())
  badge    Badge    @relation(fields: [badgeId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  createdAt DateTime @default(now())
  link      String?
  read      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("notifications")
}

model UserBehavior {
  id        String   @id @default(uuid())
  userId    String
  type      String
  targetId  String?
  metadata  Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("user_behaviors")
}

model UserInterest {
  id         String   @id @default(uuid())
  userId     String
  category   String
  weight     Int      @default(0)
  isExplicit Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])

  @@index([weight])
}

model ProductReview {
  id         String       @id @default(uuid())
  orderItem  String       @unique
  productId  String
  customerId String
  rating     Int
  comment    String?
  images     String[]
  createdAt  DateTime     @default(now())
  status     ReviewStatus @default(PENDING)
  customer   Customer     @relation(fields: [customerId], references: [id])
  item       OrderItem    @relation(fields: [orderItem], references: [id])
  product    Product      @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([status])
  @@map("product_reviews")
}

model SellerReview {
  id                  String       @id @default(uuid())
  orderId             String       @unique
  dealerId            String
  customerId          String
  rating              Int
  deliveryRating      Int?
  packagingRating     Int?
  communicationRating Int?
  comment             String?
  createdAt           DateTime     @default(now())
  status              ReviewStatus @default(PENDING)
  customer            Customer     @relation(fields: [customerId], references: [id])
  dealer              Dealer       @relation(fields: [dealerId], references: [id])
  order               Order        @relation(fields: [orderId], references: [id])

  @@index([dealerId])
  @@index([status])
  @@map("seller_reviews")
}

model Document {
  id        String   @id @default(uuid())
  userId    String
  type      String
  url       String
  status    String   @default("PENDING")
  feedback  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("documents")
}

model SubscriptionPlan {
  id                 String               @id @default(uuid())
  name               String
  price              Decimal              @db.Decimal(10, 2)
  duration           Int
  features           Json
  margin             Decimal
  rank               Int
  // Phase 6: Subscription Benefits
  wholesaleDiscount  Decimal              @default(0) @db.Decimal(5, 2) // % discount on wholesale prices
  marginBoost        Decimal              @default(0) @db.Decimal(5, 2) // Additional margin % for subscribers
  priorityAllocation Boolean              @default(false) // Priority stock access
  isActive           Boolean              @default(true) // Plan availability
  createdAt          DateTime             @default(now())
  subscriptions      DealerSubscription[]

  @@map("subscription_plans")
}

model DealerSubscription {
  id        String           @id @default(uuid())
  dealerId  String
  planId    String
  startDate DateTime         @default(now())
  endDate   DateTime
  status    String           @default("ACTIVE")
  paymentId String?
  createdAt DateTime         @default(now())
  dealer    Dealer           @relation(fields: [dealerId], references: [id])
  plan      SubscriptionPlan @relation(fields: [planId], references: [id])

  @@index([dealerId])
  @@index([status])
  @@map("dealer_subscriptions")
}

model Negotiation {
  id             String       @id @default(uuid())
  dealerId       String
  manufacturerId String
  productId      String
  status         String       @default("OPEN")
  currentOffer   Decimal      @db.Decimal(12, 2)
  quantity       Int
  chatLog        Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  dealer         Dealer       @relation(fields: [dealerId], references: [id])
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id])
  product        Product      @relation(fields: [productId], references: [id])

  @@index([dealerId])
  @@index([manufacturerId])
  @@index([status])
  @@map("negotiations")
}

enum Role {
  ADMIN
  MANUFACTURER
  DEALER
  CUSTOMER
}

enum AccountStatus {
  ACTIVE
  PENDING
  UNDER_VERIFICATION
  SUSPENDED
}

enum OrderStatus {
  CREATED
  PAID
  CONFIRMED
  SHIPPED
  DELIVERED
  SETTLED
  CANCELLED
  DISPUTED
  OUT_FOR_DELIVERY
}

enum EscrowStatus {
  HOLD
  FROZEN
  RELEASED
  REFUNDED
}

enum DisputeStatus {
  OPEN
  EVIDENCE_COLLECTION
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

enum AdminRole {
  SUPER_ADMIN
  OPS_ADMIN
  FINANCE_ADMIN
  SUPPORT_ADMIN
}

enum ProductStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}

model DealerRequest {
  id             String        @id @default(uuid())
  dealerId       String
  manufacturerId String
  status         RequestStatus @default(PENDING)
  message        String?
  metadata       Json? // Stores: expectedQuantity, region, priceExpectation
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  dealer         Dealer        @relation(fields: [dealerId], references: [id])
  manufacturer   Manufacturer  @relation(fields: [manufacturerId], references: [id])

  @@unique([dealerId, manufacturerId])
  @@map("dealer_requests")
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model PooledDemand {
  id              String            @id @default(uuid())
  manufacturerId  String
  productId       String
  targetQuantity  Int
  currentQuantity Int               @default(0)
  status          PoolStatus        @default(OPEN)
  expiresAt       DateTime
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  participants    PoolParticipant[]
  manufacturer    Manufacturer      @relation(fields: [manufacturerId], references: [id])
  product         Product           @relation(fields: [productId], references: [id])

  @@map("pooled_demands")
}

model PoolParticipant {
  id        String       @id @default(uuid())
  poolId    String
  dealerId  String
  quantity  Int
  status    String       @default("COMMITTED")
  createdAt DateTime     @default(now())
  pool      PooledDemand @relation(fields: [poolId], references: [id])
  dealer    Dealer       @relation(fields: [dealerId], references: [id])

  @@unique([poolId, dealerId])
  @@map("pool_participants")
}

enum PoolStatus {
  OPEN
  LOCKED
  FULFILLED
  EXPIRED
  CANCELLED
}

// Phase 7: Shipment Tracking
model ShipmentTracking {
  id                String    @id @default(uuid())
  orderId           String    @unique
  trackingNumber    String
  carrier           String?
  status            String    @default("PENDING") // PENDING, SHIPPED, IN_TRANSIT, OUT_FOR_DELIVERY, DELIVERED
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  statusHistory     Json? // Timeline of status updates
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  order             Order     @relation(fields: [orderId], references: [id])

  @@map("shipment_tracking")
}

// Phase 8: Performance Metrics
model DealerPerformanceMetrics {
  id                   String   @id @default(uuid())
  dealerId             String   @unique
  orderFulfillmentRate Decimal  @default(0) @db.Decimal(5, 2) // % of orders fulfilled
  averageShippingTime  Decimal  @default(0) @db.Decimal(10, 2) // Average days to ship
  disputeRate          Decimal  @default(0) @db.Decimal(5, 2) // % of orders disputed
  customerSatisfaction Decimal  @default(0) @db.Decimal(5, 2) // Average rating
  performanceScore     Decimal  @default(0) @db.Decimal(5, 2) // Calculated overall score
  totalOrders          Int      @default(0)
  lastUpdated          DateTime @updatedAt
  createdAt            DateTime @default(now())
  dealer               Dealer   @relation(fields: [dealerId], references: [id])

  @@map("dealer_performance_metrics")
}

// Phase 8: Manufacturer Blocking
model ManufacturerDealerBlock {
  id             String       @id @default(uuid())
  manufacturerId String
  dealerId       String
  reason         String
  notes          String?
  isActive       Boolean      @default(true)
  blockedAt      DateTime     @default(now())
  unblockedAt    DateTime?
  manufacturer   Manufacturer @relation(fields: [manufacturerId], references: [id])
  dealer         Dealer       @relation(fields: [dealerId], references: [id])

  @@unique([manufacturerId, dealerId])
  @@map("manufacturer_dealer_blocks")
}
